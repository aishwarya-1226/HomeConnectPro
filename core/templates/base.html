<!DOCTYPE html>
<html>
<head>
    <title>{% block title %}HomeConnectPro{% endblock %}</title>
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'styles.css' %}">
    <style>
        .messages {
            list-style: none;
            padding: 0;
        }
        .messages li {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            background-color: #f8d7da;
            color: #721c24;
        }
        #map {
            height: 500px; /* Adjust the size of the map */
            width: 100%;
        }
    </style>
    <script>
        function initMap() {
            const map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 37.7749, lng: -122.4194 },  // Default to San Francisco
                zoom: 12,
            });

            const geocoder = new google.maps.Geocoder();

            document.getElementById('property-form').addEventListener('submit', function(e) {
                e.preventDefault();

                const address = document.getElementById("address").value;
                const state = document.getElementById("state").value;
                const zipCode = document.getElementById("zip_code").value;

                if (address && state && zipCode) {
                    const fullAddress = address + ", " + state + " " + zipCode;
                    geocodeAddress(geocoder, map, fullAddress);
                } else {
                    // If address or state is not provided, use only zip code
                    const zipCode = document.getElementById("zip_code").value;
                    if (zipCode) {
                        geocodeZipCode(geocoder, map, zipCode);
                    } else {
                        // If no zip code is provided, use the default location
                        showNearbyProperties(map, { lat: 37.7749, lng: -122.4194 }); // Default San Francisco coordinates
                    }
                }
            });

            function geocodeAddress(geocoder, map, fullAddress) {
                geocoder.geocode({ 'address': fullAddress }, (results, status) => {
                    if (status === 'OK') {
                        const location = results[0].geometry.location;
                        map.setCenter(location);

                        const marker = new google.maps.Marker({
                            map: map,
                            position: location,
                        });

                        const infowindow = new google.maps.InfoWindow({
                            content: `<div><strong>${fullAddress}</strong></div>`,
                        });
                        infowindow.open(map, marker);

                        // Fetch properties based on geocoded address
                        fetchNearbyProperties(map, location);
                    } else {
                        // If geocoding fails, fall back to zip code geocoding
                        geocodeZipCode(geocoder, map, document.getElementById("zip_code").value);
                    }
                });
            }

            function geocodeZipCode(geocoder, map, zipCode) {
                geocoder.geocode({ 'address': zipCode }, (results, status) => {
                    if (status === 'OK') {
                        const location = results[0].geometry.location;
                        map.setCenter(location);

                        const marker = new google.maps.Marker({
                            map: map,
                            position: location,
                        });

                        const infowindow = new google.maps.InfoWindow({
                            content: `<div><strong>Zip Code: ${zipCode}</strong></div>`,
                        });
                        infowindow.open(map, marker);

                        // Fetch properties based on zip code location
                        fetchNearbyProperties(map, location);
                    } else {
                        alert("Zip Code not found. Showing properties from default location.");
                        // Show properties within 3-mile radius of default location if zip code not found
                        showNearbyProperties(map, { lat: 37.7749, lng: -122.4194 });
                    }
                });
            }

            function fetchNearbyProperties(map, location) {
                // Make an AJAX call to the backend to fetch properties within 3 miles
                const lat = location.lat();
                const lng = location.lng();

                fetch(`/get_properties_nearby/?lat=${lat}&lng=${lng}&radius=3`)
                    .then(response => response.json())
                    .then(properties => {
                        if (properties.length > 0) {
                            properties.forEach(property => {
                                const marker = new google.maps.Marker({
                                    map: map,
                                    position: { lat: property.latitude, lng: property.longitude },
                                });

                                const infowindow = new google.maps.InfoWindow({
                                    content: `<div><strong>${property.address}</strong></div>`,
                                });

                                marker.addListener('click', function() {
                                    infowindow.open(map, marker);
                                });
                            });
                        } else {
                            alert("No properties found within a 3-mile radius.");
                        }
                    })
                    .catch(error => {
                        console.error("Error fetching nearby properties:", error);
                    });
            }
        }

        window.onload = initMap;
    </script>
</head>
<body>
    <header>
        <h1><a href="{% url 'home' %}">Welcome to HomeConnectPro</a></h1>
        <form id="property-form" method="get" action="{% url 'search' %}">
            <input type="text" id="address" name="query" placeholder="Enter Address" value="{{ request.GET.query }}">
            <input type="text" id="state" name="state" placeholder="Enter State" value="{{ request.GET.state }}">
            <input type="text" id="zip_code" name="zipcode" placeholder="Enter Zip Code" maxlength="5" value="{{ request.GET.zip_code }}">
            <button type="submit">Search</button>
        </form>
        <nav>
            {% if user.is_authenticated %}
                <span>Welcome, {{ user.username }}</span>
                <a href="{% url 'profile' user.id %}">Profile</a>
                <a href="{% url 'logout' %}">Logout</a>
                {% if not user.is_superuser %}
                    {% if user.user_role == 'property_purchaser' %}
                        <a href="{% url 'create_property_step1' %}">Add New Listing</a>
                        <a href="{% url 'inquiry_list' %}">View Inquiries</a>
                    {% endif %}
                    {% if user.user_role == 'salesperson' %}
                        <a href="{% url 'inquiry_list' %}">View Inquiries</a>
                    {% endif %}
                    {% if user.user_role == 'client' %}
                        <a href="{% url 'inquiry_list' %}">Track Inquiries</a>
                    {% endif %}
                {% else %}
                    <!-- Admin-specific links can go here -->
                    <a href="{% url 'admin:index' %}">Admin Dashboard</a>
                {% endif %}
            {% else %}
                <a href="{% url 'signup' %}">Register</a>
                <a href="{% url 'login' %}">Login</a>
            {% endif %}
        </nav>
    </header>
    <main>
        {% if messages %}
            <ul class="messages">
                {% for message in messages %}
                    <li class="{{ message.tags }}">{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}
        {% block content %}
        {% endblock %}
    </main>
</body>
</html>
